<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Cadastro de Programa</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
<div class="max-w-4xl mx-auto bg-white p-6 rounded-2xl shadow-lg">
  <h1 class="text-2xl font-bold mb-6">Cadastro de Programa</h1>

  <!-- Formulário principal -->
  <div class="grid grid-cols-2 gap-4 mb-4">
    <div>
      <label class="block mb-1 font-medium">Código do Programa:</label>
      <input id="codigo" type="text" class="w-full border rounded p-2">
    </div>
    <div>
      <label class="block mb-1 font-medium">Padrão:</label>
      <input id="padrao1" type="number" class="w-full border rounded p-2">
    </div>
    <div>
      <label class="block mb-1 font-medium">Qtd Matrizes:</label>
      <select id="qtdMatrizes" class="w-full border rounded p-2">
        <option value="12">12 Matrizes</option>
        <option value="18">18 Matrizes</option>
      </select>
    </div>
  </div>

  <!-- Tabela Matrizaria -->
  <div class="overflow-x-auto mb-4">
    <table id="tabelaCadastro" class="w-full border border-gray-300 rounded-lg">
      <thead class="bg-gray-200">
        <tr>
          <th class="border p-2">Numeração</th>
          <th class="border p-2">Qtd Matrizes</th>
          <th class="border p-2">Saldo de Giros Inicial</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Botões de ações -->
  <div class="flex gap-4 mb-6">
    <button onclick="addLinha()" class="bg-blue-500 text-white px-4 py-2 rounded shadow hover:bg-blue-600">Adicionar Linha</button>
    <button onclick="salvarPrograma()" class="bg-green-500 text-white px-4 py-2 rounded shadow hover:bg-green-600">Salvar</button>
    <button onclick="limparBanco()" class="bg-red-500 text-white px-4 py-2 rounded shadow hover:bg-red-600">Limpar Banco</button>
  </div>
</div>

<script>
function addLinha(item = {}) {
  const tbody = document.querySelector("#tabelaCadastro tbody");
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td class="border p-2">
      <input type="number" class="num w-full p-1 border rounded" value="${item.numeracao || ''}">
    </td>
    <td class="border p-2">
      <input type="number" class="matrizes w-full p-1 border rounded" value="${item.matrizes || ''}">
    </td>
    <td class="border p-2">
      <input type="number" class="girosInicial w-full p-1 border rounded" value="${item.girosInicial || ''}">
    </td>
  `;
  tbody.appendChild(tr);
}

// Salvar (POST faz upsert no backend)
async function salvarPrograma() {
  const codigo = document.getElementById("codigo").value;
  const padrao1 = parseFloat(document.getElementById("padrao1").value);
  const qtdMatrizes = parseInt(document.getElementById("qtdMatrizes").value);

  if (!codigo || isNaN(padrao1) || isNaN(qtdMatrizes)) {
    alert("Preencha todos os campos principais!");
    return;
  }

  const dadosMatrizaria = [...document.querySelectorAll("#tabelaCadastro tbody tr")].map(tr => ({
    numeracao: parseFloat(tr.querySelector(".num").value),
    matrizes: parseFloat(tr.querySelector(".matrizes").value),
    girosInicial: parseFloat(tr.querySelector(".girosInicial").value)
  }));

  try {
    const res = await fetch("http://localhost:3000/programa", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ codigo, padrao1, qtd_matrizes: qtdMatrizes, dados_matrizaria: dadosMatrizaria })
    });
    if (res.ok) alert("Programa salvo com sucesso!");
    else alert("Erro ao salvar programa.");
  } catch (err) {
    console.error(err);
    alert("Erro ao conectar com o servidor.");
  }
}

//limpar BD
async function limparBanco() {
  const senha = prompt("Digite a senha para limpar o banco de dados:");

  if (senha !== "24112024") {
    alert("Senha incorreta! Operação cancelada.");
    return;
  }

  if (!confirm("Tem certeza que deseja limpar todo o banco de dados?")) return;

  try {
    const res = await fetch("http://localhost:3000/programa", { method: "DELETE" });
    if (res.ok) {
      alert("Banco de dados limpo com sucesso!");
    } else {
      const text = await res.text();
      alert("Erro ao limpar banco: " + text);
    }
  } catch (err) {
    console.error(err);
    alert("Erro ao conectar com o servidor: " + err.message);
  }
}

</script>
</body>
</html>
